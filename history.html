<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>送信履歴 - 福岡市薬剤師会</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Mobile History Improvements - Inline for immediate effect */
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.7rem !important;
            }

            .data-table th,
            .data-table td {
                padding: 0.4rem 0.3rem !important;
            }

            /* 対象とステータス列を非表示 */
            .data-table th:nth-child(3),
            .data-table td:nth-child(3),
            .data-table th:nth-child(5),
            .data-table td:nth-child(5) {
                display: none !important;
            }

            /* 日時を短縮表示 */
            .data-table td:first-child {
                font-size: 0.6rem !important;
                max-width: 70px;
                word-break: break-all;
            }

            /* タイトル列を狭く */
            .data-table td:nth-child(2) {
                max-width: 100px !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* モーダル改善 */
            .modal {
                width: 95% !important;
                max-width: none !important;
                max-height: 85vh !important;
                margin: 0.5rem !important;
            }

            .modal-body {
                padding: 0.8rem !important;
                font-size: 0.85rem !important;
            }

            .modal-body img {
                max-width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="brand">
            <div class="brand-icon"><i class="fa-brands fa-line fa-lg"></i></div>
            <span>福岡市薬剤師会<br>公式LINE管理</span>
        </div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="index.html" class="nav-link"><i class="fa-solid fa-chart-pie"></i> ダッシュボード</a>
            </li>
            <li class="nav-item"><a href="create-campaign.html" class="nav-link"><i
                        class="fa-solid fa-pen-to-square"></i> 新規配信作成</a></li>
            <li class="nav-item"><a href="history.html" class="nav-link active"><i
                        class="fa-solid fa-clock-rotate-left"></i> 送信履歴</a></li>
            <li class="nav-item"><a href="audience.html" class="nav-link"><i class="fa-solid fa-users"></i> 友だち・タグ管理</a>
            </li>
            <li class="nav-item"><a href="admin-users.html" class="nav-link"><i class="fa-solid fa-user-shield"></i>
                    管理者設定</a></li>
            <li class="nav-item" style="margin-top: auto;"><a href="#" onclick="logout()" class="nav-link"><i
                        class="fa-solid fa-right-from-bracket"></i> ログアウト</a></li>
        </ul>
    </div>

    <div class="main-content">
        <header class="header">
            <button id="menu-toggle" class="mobile-menu-btn"><i class="fa-solid fa-bars"></i></button>
            <h1 class="page-title">送信履歴</h1>
            <div class="user-profile">
                <span>管理者: <strong id="admin-name">読み込み中...</strong></span>
                <div class="avatar">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff" alt="User"
                        style="width:100%;height:100%;">
                </div>
            </div>
        </header>

        <div class="section-card" style="margin-bottom:1rem; display:flex; gap:1rem; align-items:center;">
            <button class="btn btn-primary btn-sm" id="refresh-btn" onclick="refreshHistory()">
                <i class="fa-solid fa-arrows-rotate"></i> 更新
            </button>
            <span id="refresh-status" style="font-size:0.85rem; color:#666;"></span>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>日時</th>
                        <th>タイトル</th>
                        <th>対象</th>
                        <th>送信数</th>
                        <th>ステータス</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                    <tr>
                        <td colspan="6" style="text-align:center; color:#999; padding:2rem;">読み込み中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">配信内容詳細</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        let campaignsData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // セッション確認
            const adminName = localStorage.getItem('adminName');
            if (adminName) {
                document.getElementById('admin-name').textContent = adminName;
            }

            await loadHistory();
            historyInitModal();
        });

        async function loadHistory() {
            try {
                const response = await fetch('/api/campaigns');
                let allCampaigns = await response.json();

                // キャンセル済みを除外
                campaignsData = allCampaigns.filter(c => c.status !== 'cancelled');

                const tbody = document.getElementById('history-tbody');

                if (campaignsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999; padding:2rem;">配信履歴がありません</td></tr>';
                    return;
                }

                // 新しい順に並べ替え
                campaignsData.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));

                let html = '';
                campaignsData.forEach((campaign, index) => {
                    const date = campaign.sentAt ? new Date(campaign.sentAt).toLocaleString('ja-JP') : '-';
                    let statusBadge;
                    if (campaign.status === 'sent') {
                        statusBadge = '<span class="badge badge-sent">送信済</span>';
                    } else if (campaign.status === 'cancelled') {
                        statusBadge = '<span class="badge" style="background:#9ca3af; color:white;">キャンセル</span>';
                    } else if (campaign.status === 'scheduled') {
                        const scheduledTime = new Date(campaign.sentAt).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        statusBadge = `<span class="badge badge-scheduled">予約<br><small>${scheduledTime}</small></span>`;
                    }

                    html += `
                        <tr>
                            <td>${date}</td>
                            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${campaign.title || '-'}</td>
                            <td>${campaign.target || '-'}</td>
                            <td><strong>${campaign.count || 0}名</strong></td>
                            <td>${statusBadge}</td>
                            <td><button class="btn btn-sm" style="color:var(--primary-color);" onclick="showDetail(${index})"><i class="fa-solid fa-eye"></i> 詳細</button></td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            } catch (error) {
                console.error('Load history error:', error);
            }
        }

        function showDetail(index) {
            const campaign = campaignsData[index];
            if (!campaign) return;

            const date = campaign.sentAt ? new Date(campaign.sentAt).toLocaleString('ja-JP') : '-';

            let imageHtml = '';
            if (campaign.imageUrl && campaign.imageUrl.trim() !== '') {
                // 画像URLを適切に処理
                let displayImageUrl = campaign.imageUrl;
                let isOldFormat = false;

                // /uploads/ パスは古い形式（Renderでは表示不可）
                if (campaign.imageUrl.includes('/uploads/')) {
                    isOldFormat = true;
                } else if (campaign.imageUrl.includes('/api/proxy-image/')) {
                    // Google Driveプロキシの場合
                    const proxyIndex = campaign.imageUrl.indexOf('/api/proxy-image/');
                    displayImageUrl = campaign.imageUrl.substring(proxyIndex);
                } else if (campaign.imageUrl.match(/^[a-zA-Z0-9_-]{20,}$/)) {
                    // Google Drive fileId のみの場合（長い英数字文字列）
                    displayImageUrl = `/api/proxy-image/${campaign.imageUrl}`;
                } else if (campaign.imageUrl.startsWith('http')) {
                    // 外部URLの場合はそのまま使用
                    displayImageUrl = campaign.imageUrl;
                }

                if (isOldFormat) {
                    imageHtml = `
                        <div style="margin-bottom:1.5rem;">
                            <label style="font-weight:600; color:#333; display:block; margin-bottom:0.5rem;">
                                <i class="fa-solid fa-image"></i> 画像
                            </label>
                            <div style="padding:1rem; background:#fff3cd; border-radius:8px; color:#856404;">
                                <i class="fa-solid fa-info-circle"></i> この画像は旧システムで保存されたため表示できません<br>
                                <small>今後アップロードする画像は正常に表示されます</small>
                            </div>
                        </div>
                    `;
                } else {
                    imageHtml = `
                        <div style="margin-bottom:1.5rem;">
                            <label style="font-weight:600; color:#333; display:block; margin-bottom:0.5rem;">
                                <i class="fa-solid fa-image"></i> 画像
                            </label>
                            <img src="${displayImageUrl}" alt="配信画像" style="max-width:100%; border-radius:8px; border:1px solid #ddd;" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display:none; padding:1rem; background:#f8f9fa; border-radius:8px; color:#666;">
                                <i class="fa-solid fa-exclamation-triangle"></i> 画像を読み込めませんでした
                            </div>
                        </div>
                    `;
                }
            } else {
                // 画像がない場合
                imageHtml = `
                    <div style="margin-bottom:1.5rem;">
                        <label style="font-weight:600; color:#333; display:block; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-image"></i> 画像
                        </label>
                        <div style="padding:1rem; background:#f0f0f0; border-radius:8px; color:#666;">
                            <i class="fa-solid fa-image"></i> 画像なし
                        </div>
                    </div>
                `;
            }

            let linksHtml = '';
            if (campaign.detailLink || campaign.applyLink) {
                linksHtml = `
                    <div style="margin-bottom:1rem;">
                        <label style="font-weight:600; color:#333; display:block; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-link"></i> リンク
                        </label>
                        <div style="background:#f8f9fa; padding:1rem; border-radius:8px;">
                `;
                if (campaign.detailLink) {
                    linksHtml += `<div style="margin-bottom:0.5rem;"><strong>詳細ページ:</strong> <a href="${campaign.detailLink}" target="_blank" style="color:#06C755;">${campaign.detailLink}</a></div>`;
                }
                if (campaign.applyLink) {
                    linksHtml += `<div><strong>申し込み:</strong> <a href="${campaign.applyLink}" target="_blank" style="color:#06C755;">${campaign.applyLink}</a></div>`;
                }
                linksHtml += '</div></div>';
            }

            // 予約キャンセルボタン（予約中のみ表示）
            let cancelHtml = '';
            if (campaign.status === 'scheduled') {
                cancelHtml = `
                    <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px dashed #ddd;">
                        <button onclick="cancelSchedule(${index})" class="btn" style="width:100%; background:#ef4444; color:white;">
                            <i class="fa-solid fa-ban"></i> 予約をキャンセル
                        </button>
                    </div>
                `;
            }

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div style="background:linear-gradient(135deg, ${campaign.status === 'scheduled' ? '#f59e0b, #d97706' : '#06C755, #00B140'}); color:white; padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:0.85rem; opacity:0.9;">${campaign.status === 'scheduled' ? '配信予定日時' : '配信日時'}</div>
                            <div style="font-weight:600;">${date}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.85rem; opacity:0.9;">${campaign.status === 'scheduled' ? '予定送信数' : '送信数'}</div>
                            <div style="font-size:1.5rem; font-weight:700;">${campaign.count || 0}名</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom:1.5rem;">
                    <label style="font-weight:600; color:#333; display:block; margin-bottom:0.5rem;">
                        <i class="fa-solid fa-heading"></i> タイトル
                    </label>
                    <div style="font-size:1.1rem; font-weight:600;">${campaign.title || '-'}</div>
                </div>
                
                <div style="margin-bottom:1.5rem;">
                    <label style="font-weight:600; color:#333; display:block; margin-bottom:0.5rem;">
                        <i class="fa-solid fa-users"></i> 対象
                    </label>
                    <span class="badge" style="background:#e0f2fe; color:#0369a1;">${campaign.target || '-'}</span>
                </div>
                
                <div style="margin-bottom:1.5rem;">
                    <label style="font-weight:600; color:#333; display:block; margin-bottom:0.5rem;">
                        <i class="fa-solid fa-align-left"></i> 本文
                    </label>
                    <div style="background:#f8f9fa; padding:1rem; border-radius:8px; white-space:pre-wrap;">${campaign.description || '（本文なし）'}</div>
                </div>
                
                ${imageHtml}
                ${linksHtml}
                ${cancelHtml}
            `;

            document.getElementById('detail-modal').classList.add('active');
        }

        // 予約キャンセル
        async function cancelSchedule(index) {
            const campaign = campaignsData[index];
            if (!campaign || !confirm('この予約配信をキャンセルしてもよろしいですか？')) return;

            try {
                const response = await fetch(`/api/campaigns/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sentAt: campaign.sentAt })
                });
                const data = await response.json();

                if (data.success) {
                    alert('✅ 予約をキャンセルしました');
                    document.getElementById('detail-modal').classList.remove('active');
                    await loadHistory();
                } else {
                    alert('❌ ' + (data.error || 'キャンセルに失敗しました'));
                }
            } catch (error) {
                alert('❌ エラー: ' + error.message);
            }
        }

        function historyInitModal() {
            const modal = document.getElementById('detail-modal');
            const closeBtn = document.getElementById('modal-close');

            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    modal.classList.remove('active');
                });
            }

            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            }
        }

        async function refreshHistory() {
            const btn = document.getElementById('refresh-btn');
            const status = document.getElementById('refresh-status');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 更新中...';
            status.textContent = '';

            try {
                await loadHistory();
                status.textContent = '✅ 更新完了 (' + new Date().toLocaleTimeString('ja-JP') + ')';
                status.style.color = '#059669';
            } catch (error) {
                status.textContent = '❌ 更新失敗';
                status.style.color = '#dc2626';
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i> 更新';
        }

        function logout() {
            localStorage.removeItem('sessionId');
            localStorage.removeItem('adminName');
            window.location.href = '/login.html';
        }
    </script>
    <script src="js/app.js"></script>
</body>

</html>